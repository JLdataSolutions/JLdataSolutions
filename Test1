WITH UDEF_TS_APPROVAL_HISTORY AS (SELECT        dbo.TS_APPROVAL_LOG.APAL_PRIMARY AS __PRIMARY, dbo.TS_APPROVAL_LOG.APAL_RECORD_TYPE AS __RECORD_TYPE, 
                                                                                                                      dbo.TS_APPROVAL_LOG.APAL_RECORD_LINK AS __RECORD_LINK, 
                                                                                                                      CASE APAL_PREV_ACTION WHEN 0 THEN 'Waiting' WHEN 1 THEN 'Submitted' WHEN 2 THEN 'Approved' WHEN 3 THEN 'Rejected' WHEN 4 THEN 'Rerouted' WHEN 5 THEN 'Reopened'
                                                                                                                       WHEN 6 THEN 'Unsubmitted' WHEN 7 THEN 'Cancelled' ELSE '' END AS 'Previous Action', dbo.TS_APPROVAL_LOG.APAL_INSERTED_DATE AS 'Previous Action Date', 
                                                                                                                      ISNULL(dbo.TS_APPROVAL_LOG.APAL_PREV_ACTION_USERID, '') AS 'User ID', ISNULL(SYS_USER_1.USER_NAME, '') AS 'User Name', 
                                                                                                                      ISNULL(dbo.TS_APPROVAL_STAGE.APAS_NAME, 'N/A') AS 'Stage', dbo.TS_APPROVAL_LOG.APAL_THIS_ACTION_USERID AS Assigned_User, ISNULL(dbo.SYS_USER.USER_NAME, '') 
                                                                                                                      AS 'Assigned Name', dbo.TS_APPROVAL_LOG.APAL_ACTIONED_DATE AS 'This Action Date', CASE ISNULL(APAL_STATUS, 0) 
                                                                                                                      WHEN 0 THEN 'Pending' WHEN 1 THEN 'Awaiting Approval' WHEN 2 THEN 'Approved' WHEN 3 THEN 'Posted' WHEN 4 THEN 'Rejected' WHEN 5 THEN 'Cancelled' END AS 'Status', 
                                                                                                                      dbo.TS_APPROVAL_LOG.APAL_CURRENT
                                                                                            FROM            dbo.SYS_USER RIGHT OUTER JOIN
                                                                                                                      dbo.TS_USERS ON dbo.SYS_USER.USER_ID = dbo.TS_USERS.TSU_USERID RIGHT OUTER JOIN
                                                                                                                      dbo.TS_APPROVAL_LOG ON dbo.TS_USERS.TSU_USERID = dbo.TS_APPROVAL_LOG.APAL_THIS_ACTION_USERID AND 
                                                                                                                      dbo.TS_APPROVAL_LOG.APAL_RECORD_TYPE = 'PIR' LEFT OUTER JOIN
                                                                                                                      dbo.TS_APPROVAL_STAGE ON dbo.TS_APPROVAL_LOG.APAL_APAS_PRIMARY = dbo.TS_APPROVAL_STAGE.APAS_PRIMARY LEFT OUTER JOIN
                                                                                                                      dbo.TS_USERS AS TS_USERS_1 ON dbo.TS_APPROVAL_LOG.APAL_PREV_ACTION_USERID = TS_USERS_1.TSU_USERID LEFT OUTER JOIN
                                                                                                                      dbo.SYS_USER AS SYS_USER_1 ON TS_USERS_1.TSU_USERID = SYS_USER_1.USER_ID)
    SELECT DISTINCT 
                              UDEF_TS_APPROVAL_HISTORY. 'Previous Action', UDEF_TS_APPROVAL_HISTORY. 'Previous Action Date', UDEF_TS_APPROVAL_HISTORY. 'User ID', UDEF_TS_APPROVAL_HISTORY. 'User Name', 
                              UDEF_TS_APPROVAL_HISTORY. 'Stage', UDEF_TS_APPROVAL_HISTORY.APAL_CURRENT, UDEF_TS_APPROVAL_HISTORY. 'Status', UDEF_TS_APPROVAL_HISTORY.__RECORD_TYPE, 
                              UDEF_TS_APPROVAL_HISTORY.__PRIMARY, SYS_DATAINFO.COMPANY_NAME, SYS_DATAINFO.HOME_CURR_SYMBL, UDEF_TS_APPROVAL_HISTORY.__RECORD_LINK, dbo.PL_TRANSACTIONS.PT_TRANTYPE, 
                              dbo.PL_TRANSACTIONS.PT_HEADER_REF, dbo.PL_TRANSACTIONS.PT_DESCRIPTION, dbo.PL_TRANSACTIONS.PT_DATE, dbo.PL_TRANSACTIONS.PT_DUEDATE, 
                              CASE WHEN PT_tRANTYPE = 'crn' THEN - PL_TRANSACTIONS.PT_GROSS ELSE PL_TRANSACTIONS.PT_GROSS END AS PT_GROSS, dbo.PL_TRANSACTIONS.PT_CURRENCYCODE, dbo.PL_TRANSACTIONS.PT_CURR_VALU, 
                              dbo.PL_TRANSACTIONS.PT_ORDER_NUMBER, dbo.PL_TRANSACTIONS.PT_DATE_RECEIVED, dbo.PL_TRANSACTIONS.PT_DATE_PUTIN, dbo.PL_TRANSACTIONS.PT_COPYSUPP, PL_ACCOUNTS.SUNAME, 
                              dbo.PL_TRANSACTIONS.PT_BATCH_FLAG, UDEF_TS_APPROVAL_HISTORY.Assigned_User, UDEF_TS_APPROVAL_HISTORY. 'Assigned Name', UDEF_TS_APPROVAL_HISTORY. 'This Action Date', 
                              dbo.PL_TRANSACTIONS.PT_INVREG_APPROVER1, dbo.PL_TRANSACTIONS.PT_PRIMARY
     FROM            dbo.PL_TRANSACTIONS LEFT OUTER JOIN
                              UDEF_TS_APPROVAL_HISTORY ON UDEF_TS_APPROVAL_HISTORY.__RECORD_LINK = dbo.PL_TRANSACTIONS.PT_PRIMARY AND UDEF_TS_APPROVAL_HISTORY.APAL_CURRENT = 1 INNER JOIN
                              dbo.SYS_DATAINFO AS SYS_DATAINFO ON UDEF_TS_APPROVAL_HISTORY. 'Previous Action' <> SYS_DATAINFO.COMPANY_NAME LEFT OUTER JOIN
                              dbo.PL_ACCOUNTS AS PL_ACCOUNTS ON dbo.PL_TRANSACTIONS.PT_COPYSUPP = PL_ACCOUNTS.SUCODE
     WHERE        (dbo.PL_TRANSACTIONS.PT_INVREG_FLAG = 1)
